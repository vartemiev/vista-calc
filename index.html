<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans&family=Nunito:wght@200&family=Thasadith&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
    }

    input {
      font-family: 'Thasadith', sans-serif;
    }

    .digit {
      font-family: 'Josefin Sans', sans-serif;
      font-weight: bold;
      font-size: 22px;
    }

    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .leverage-result {
      background-color: #b5eab4;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
      text-align: right;
      font-size: 0.9rem;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>

<body>
<div class="container" style="margin: 20px 100px; width: 50%">
  <div id="eurRate" style="padding: 20px 0; display: none" >
    <span style="color: #9c9c9c">Курс EUR / RUB:</span> <span id="eurValue"></span> (<span style="color: #9c9c9c" id="eurDate"></span>)
  </div>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link" id="new-account-tab" href="#">Новый счет</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="leverage-tab" href="#">Прокачка</a>
    </li>
  </ul>

  <form id="new-account" style="margin: 20px">
    <div class="form-group">
      <label for="start">Начальная сумма</label>
      <input type="number" id="start" class="form-control" value="1100" min="1000">
    </div>

    <div class="row" style="padding: 20px" >
      <div class="form-group col-sm-6" id="radio-group1">
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="withLeverage" name="radio-group1" checked>
          <label class="custom-control-label" for="withLeverage">С ежемесячной прокачкой</label>
        </div>
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="onceUpdate" name="radio-group1">
          <label class="custom-control-label" for="onceUpdate">Прокачать один раз</label>
        </div>
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="withLoan" name="radio-group1">
          <label class="custom-control-label" for="withLoan">С займом 70% каждый месяц</label>
        </div>
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="withoutLoan" name="radio-group1">
          <label class="custom-control-label" for="withoutLoan">Без займа</label>
        </div>
      </div>

      <div class="form-group col-sm-6" id="radio-group2">
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="noAddNoRemove" name="radio-group2" checked>
          <label class="custom-control-label" for="noAddNoRemove">Не снимать и не пополнять</label>
        </div>
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="addMonthly" name="radio-group2">
          <label class="custom-control-label" for="addMonthly">Пополнять ежемесячно</label>
        </div>
        <div class="custom-control custom-radio">
          <input type="radio" class="custom-control-input" id="removeMonthly" name="radio-group2">
          <label class="custom-control-label" for="removeMonthly">Снимать ежемесячно</label>
        </div>
      </div>
    </div>

    <div class="form-group" id="new-monthlyAdding">
      <label for="monthValue" id="withdrawLabel" style="display: none">Сумма ежемесячного cнятия</label>
      <label for="monthValue" id="addLabel" style="display: block">Сумма ежемесячного пополнения</label>
      <input type="number" id="monthValue" class="form-control">
    </div>
    <div id="max-withdraw" class="leverage-result" style="display: none;">
      <div>
        <div class="result">Максимально допустимая сумма:</div>
        <div class="digit" id="withdraw-amount"></div>
      </div>
    </div>
    <div class="form-group" id="new-monthsCount">
      <label for="monthsCount">Количество месяцев</label>
      <input type="number" id="monthsCount" class="form-control">
    </div>
    <button type="button" class="btn btn-success" id="calculate">Рассчитать</button>

    <div id="new-result" class="leverage-result" style="display: none;">
      <div>
        <div class="result">Доступно к снятию на конец срока:</div>
        <div class="digit" id="amount"></div>
      </div>
      <div>
        <div class="result">Вложено всего:</div>
        <div class="digit" id="our"></div>
      </div>
      <div>
        <div class="result">Ежемесячные дивиденды:</div>
        <div class="digit" id="profit"></div>
      </div>
    </div>
  </form>


  <form id="leverage" style="margin: 20px">
    <div class="form-group">
      <label for="balance">Текущий баланс</label>
      <input type="number" id="balance" class="form-control" value="" min="" />
    </div>
    <div class="form-group">
      <label for="loan">Текущий займ</label>
      <input type="number" id="loan" class="form-control" value="" min="" />
    </div>
    <div class="form-group">
      <label for="contract">Текущий контракт</label>
      <input type="number" id="contract" class="form-control" value="" min="" />
    </div>
    <button type="button" class="btn btn-success" id="leverage-calc">Рассчитать</button>

    <div id="result" class="leverage-result" style="display: none;">
      <div>
        <div class="result">Новый контракт: </div>
        <div class="digit" id="new-contract"></div>
      </div>
      <div>
        <div class="result">Результирующий баланс: </div>
        <div class="digit" id="result-amount"></div>
      </div>
      <div>
        <div class="result">Кредитное плечо: </div>
        <div class="digit" id="leverage-result"></div>
      </div>
    </div>
  </form>
</div>
</body>

<script>
  const RestockingStatus = {
    NO_ADD_NO_REMOVE: 'noAddNoRemove',
    REMOVE_MONTHLY: 'removeMonthly',
    ADD_MONTHLY: 'addMonthly',
  };
  const LeverageStatus = {
    WITH_LEVERAGE: 'withLeverage',
    WITHOUT_LOAN: 'withoutLoan',
    ONCE_UPDATE: 'onceUpdate',
    WITH_LOAN: 'withLoan',
  };
  const MONTHS = [
    'января',
    'февраля',
    'марта',
    'апреля',
    'мая',
    'июня',
    'июля',
    'августа',
    'сентября',
    'октября',
    'ноября',
    'декабря',
  ];
  const RATES = [
    2.29,
    2.19,
    1.23,
    1.16,
    2.28,
    2.23,
    1.95,
    2,
    1.93,
    2.17,
    1.95,
    2.08,
    2.32,
    2.23,
    1.23,
    1.16,
    2.28,
    2.23,
    1.95,
    2,
    1.93,
    2.17,
    1.95,
    2.08,
    2.32,
    2.23,
    1.23,
    1.16,
    2.28,
    2.23,
    1.95,
    2,
    1.93,
    2.17,
    1.95,
    2.08,
    2.32,
    2.23,
    1.23,
    1.94,
    2.07,
    1.87,
    1.76,
    1.37,
    1.23,
    2.15,
    2.17,
    1.83,
    2.21,
    1.94,
    2.16,
    1.56,
    2.23,
    2.52,
    2.14,
    2.41,
    2.16,
    2.21,
    1.71,
    1.8,
    2.07,
    2.25,
    1.62,
    1.15,
    2.05,
    2.16,
    1.96,
    1.87,
    2.14,
    2.07,
    1.98,
    2.23,
    2.25,
    2.32,
    1.26,
    1.06,
    2.25,
    2.14,
    1.98,
    1.78,
    2.25,
    2.52,
    2.32,
    1.87,
    2.07,
    1.89,
    1.26,
    0.86,
    2.52,
    2.61,
    1.15,
    2.16,
    1.26,
    2.43,
    1.08,
    2.5,
    2.7,
    2.61,
    0.18,
    0.81,
    2.25,
    2.07,
    2.16,
    2.32,
    2.05,
    1.62,
    2.23,
    2.52,
    2.41,
    2.14,
    0.9,
    0.72,
    2.61,
    2.25,
    2.5,
    2.07,
    2.41,
    2.16,
    2.14,
    1.8,
    2.52,
    2.43,
    1.14,
  ];


  const MIN_CONTRACT = 10000;
  const AVERAGE_RATE = 1.95;
  const AJIO = 0.07;
  const LOAN_KOEF = 0.7;

  let maxWithdrawValue = 0;

  const twoDigits = amount => +amount.toFixed(2);

  const loan = amount => twoDigits(amount * LOAN_KOEF);
  const leverage = amount =>  twoDigits(amount / 3 * 7);
  const workFee = amount => twoDigits(amount * 0.2);
  const serviceFee = amount => twoDigits(amount / 12 / 100);
  const loanFee = amount => twoDigits(amount * 7 / 12 / 100);
  const averageRate = () => RATES.reduce((average, rate) => average + rate, 0) / RATES.length / 100;

  const Profit = {
    withLeverage: (income, amount) => twoDigits(income - workFee(income) - serviceFee(amount + leverage(amount)) - loanFee(leverage(amount))),
    withLoan: (income, amount) => twoDigits(income - workFee(income) - serviceFee(amount + loan(amount)) - loanFee(loan(amount))),
    withoutLoan: (income, amount) => twoDigits(income - workFee(income) - serviceFee(amount)),
    onceUpdate: (income, amount, leverage) => twoDigits(income - workFee(income) - serviceFee(amount) - loanFee(leverage)),
  }

  const UpdateContract = {
    withLeverage: (amount, contract) => Math.ceil((10 * amount - 3 * contract) / 3.7),
    withLoan: (amount, contract) => Math.ceil((1.7 * amount -  contract) / 1.119),
    withoutLoan: (amount, contract) => amount - contract,
  }

  const Income = {
    withLeverage: (amount, rate) => twoDigits((amount + leverage(amount)) * rate / 100),
    withLoan: (amount, rate) => twoDigits((amount + loan(amount)) * rate / 100),
    withoutLoan: (amount, rate) => twoDigits(amount * rate / 100),
  }

  const defineMaxWithdraw = (amount, leverageStatus) => {
    let withdrawRate;

    switch (leverageStatus) {
      case LeverageStatus.WITH_LEVERAGE:
      case LeverageStatus.ONCE_UPDATE:
        withdrawRate = 3.55;
        break;

      case LeverageStatus.WITH_LOAN:
        withdrawRate = 2.09;
        break;

      default:
        withdrawRate = AVERAGE_RATE;
    }

    return amount * withdrawRate / 100;
  }
  const getWigthdrawAmount = () => {
    const enteredAmount = +document.querySelector('#start').value;
    const contract = enteredAmount - 100 > MIN_CONTRACT ? enteredAmount - 100 : MIN_CONTRACT;
    const amount = Math.round((enteredAmount - 100) - AJIO * contract);
    const leverageStatus = document.querySelector('[name="radio-group1"]:checked').id;

    return Math.floor(defineMaxWithdraw(amount, leverageStatus));
  };

  const formatDate = (timestamp) => {
    const [date] = timestamp.split('T');
    const [year, month, day] = date.split('-');

    return `${day} ${MONTHS[+month - 1]} ${year}`;
  }

  const format = (amount) => {
    const string = Math.round(amount).toString().split('');

    let res = '';
    while (string.length > 0) {
      res += string
              .splice(0, string.length % 3 || 3)
              .join('');
      res += ' ';
    }

    return res;
  };

  const defineAmount = (restockingStatus) => {
    switch (restockingStatus) {
      case RestockingStatus.NO_ADD_NO_REMOVE:
        return 0;

      case RestockingStatus.ADD_MONTHLY:
        return +document.querySelector('#monthValue').value;

      case RestockingStatus.REMOVE_MONTHLY:
        return -(+document.querySelector('#monthValue').value);
    }
  };

  const makeCalculations = (enteredAmount, monthsCount, monthValue, leverageStatus) => {
    let contract = enteredAmount - 100 > MIN_CONTRACT ? enteredAmount - 100 : MIN_CONTRACT;
    let amount = Math.round((enteredAmount - 100) - AJIO * contract);

    RATES.slice(-monthsCount).forEach(
            (rate) => {
              const updatedContract = UpdateContract[leverageStatus](amount, contract);
              if (updatedContract > 0) {
                contract += updatedContract;
                amount = twoDigits(amount - updatedContract * AJIO);
              }

              const inc = Income[leverageStatus](amount, rate);
              const profit = Profit[leverageStatus](inc, amount);

              amount = twoDigits(amount + profit + monthValue);
            }
    );

    amount -= monthValue;
    const averageIncome = Income[leverageStatus](amount, AVERAGE_RATE);
    const averageProfit = Profit[leverageStatus](averageIncome, amount);

    document.querySelector('#amount').innerText = format(amount);
    document.querySelector('#our').innerText = format(monthValue * monthsCount + enteredAmount);
    document.querySelector('#profit').innerText = format(Math.floor(averageProfit));

    document.querySelector('#new-result').style.display = 'block';
  };

  const onceRestocking = (enteredAmount, monthsCount, monthValue) => {
    let contract = enteredAmount - 100 > MIN_CONTRACT ? enteredAmount - 100 : MIN_CONTRACT;
    let amount = Math.round((enteredAmount - 100) - AJIO * contract);

    const updatedContract = UpdateContract.withLeverage(amount, contract);
    if (updatedContract > 0) {
      contract += updatedContract;
      amount = twoDigits(amount - updatedContract * AJIO);
    }

    const _leverage = leverage(amount);
    amount += _leverage;
    const initialAmount = amount;

    RATES.slice(-monthsCount).forEach((rate, i) => {
      const updatedContract = UpdateContract.withoutLoan(initialAmount + i * monthValue, contract);
      if (updatedContract > 0) {
        contract += updatedContract;
        amount = twoDigits(amount - updatedContract * AJIO);
      }

      const inc = Income.withoutLoan(amount, rate);
      const profit = Profit.onceUpdate(inc, amount, _leverage);

      amount = twoDigits(amount + profit + monthValue);
    });

    amount -= monthValue;
    const averageIncome = Income.withoutLoan(amount, AVERAGE_RATE);
    const averageProfit = Profit.withLoan(averageIncome, amount);

    document.querySelector('#amount').innerText = format(amount - _leverage);
    document.querySelector('#our').innerText = format(monthValue * monthsCount + enteredAmount);
    document.querySelector('#profit').innerText = format(Math.floor(averageProfit));

    document.querySelector('#new-result').style.display = 'block';
  }

  const calculateValue = () => {
    const leverageStatus = document.querySelector('[name="radio-group1"]:checked').id;
    const restockingStatus = document.querySelector('[name="radio-group2"]:checked').id;

    const enteredAmount = +document.querySelector('#start').value;
    const monthsCount = +document.querySelector('#monthsCount').value;
    const monthValue = defineAmount(restockingStatus);

    switch (leverageStatus) {
      case LeverageStatus.WITH_LEVERAGE:
        makeCalculations(enteredAmount, monthsCount, monthValue, LeverageStatus.WITH_LEVERAGE);
        break;

      case LeverageStatus.WITH_LOAN:
        makeCalculations(enteredAmount, monthsCount, monthValue, LeverageStatus.WITH_LOAN);
        break;

      case LeverageStatus.WITHOUT_LOAN:
        makeCalculations(enteredAmount, monthsCount, monthValue, LeverageStatus.WITHOUT_LOAN);
        return;

      case LeverageStatus.ONCE_UPDATE:
        onceRestocking(enteredAmount, monthsCount, monthValue);
        return;

    }
  };

  document.querySelector('#calculate').addEventListener('click', calculateValue);

  const init = () => {
    const accTab = document.querySelector('#new-account-tab');
    const levTab = document.querySelector('#leverage-tab');

    const accForm = document.querySelector('#new-account');
    const levForm = document.querySelector('#leverage');

    accTab.addEventListener('click', () => {
      accTab.classList.add('active')
      levTab.classList.remove('active');

      accForm.style.display = 'block';
      levForm.style.display = 'none';
    });

    levTab.addEventListener('click', () => {
      accTab.classList.remove('active')
      levTab.classList.add('active');

      accForm.style.display = 'none';
      levForm.style.display = 'block';
    });

    document.querySelector('#removeMonthly').addEventListener('change', () => {
      document.querySelector('#withdrawLabel').style.display = 'block';
      document.querySelector('#addLabel').style.display = 'none';

      document.querySelector('#max-withdraw').style.display = 'block';
      document.querySelector('#withdraw-amount').innerText = getWigthdrawAmount();
    });

    document.querySelector('#addMonthly').addEventListener('change', () => {
      document.querySelector('#withdrawLabel').style.display = 'none';
      document.querySelector('#addLabel').style.display = 'block';
      document.querySelector('#max-withdraw').style.display = 'none';
    });

    document.querySelector('#noAddNoRemove').addEventListener('change', () => {
      document.querySelector('#new-monthlyWithdraw').style.display = 'none';
      document.querySelector('#new-monthlyAdding').style.display = 'none';
      document.querySelector('#max-withdraw').style.display = 'none';
    });

    accTab.click();

    fetch('https://www.cbr-xml-daily.ru/daily_json.js')
            .then(response => response.json())
            .then(daylyInfo => {
              document.querySelector('#eurValue').innerText = daylyInfo.Valute.EUR.Value;
              document.querySelector('#eurDate').innerText = formatDate(daylyInfo.Date);
              document.querySelector('#eurRate').style.display = 'block';
            });
  }

  const calculateBoost = () => {
    const balance = +document.querySelector('#balance').value;
    const loan = +document.querySelector('#loan').value;
    let contract = +document.querySelector('#contract').value;

    let amount = twoDigits(balance - loan);
    const updatedContract = UpdateContract.withLeverage(amount, contract);
    if (updatedContract > 0) {
      contract = Math.ceil(contract + updatedContract);
      amount = twoDigits(amount - updatedContract * AJIO);
      document.querySelector('#new-contract').innerText = `${format(contract)} EUR`;
      document.querySelector('#result-amount').innerText = `${format(amount)} EUR`;
    }

    document.querySelector('#leverage-result').innerText = `${format(Math.floor(leverage(amount)))} EUR`;
    document.querySelector('#result').style.display = 'block';
  };

  document.querySelector('#leverage-calc').addEventListener('click', calculateBoost);

  init();

</script>
</html>